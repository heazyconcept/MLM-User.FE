<div class="min-h-screen bg-slate-50">
  <main class="py-8">
    <div class="px-4 sm:px-6 lg:px-8 mx-auto">
      <div class="space-y-6 h-full flex flex-col animate-fade-in">
        <!-- Header -->
        <div class="flex items-center justify-between">
          <div class="flex items-center gap-4">
            @if (!isRootView()) {
              <button 
                (click)="navigateToTop()"
                class="group flex items-center gap-2 px-3 py-2 rounded-xl bg-white border border-gray-200 hover:border-gray-300 hover:bg-gray-50 transition-all duration-200 text-gray-700 text-sm font-medium shadow-sm hover:shadow">
                <i class="pi pi-arrow-left text-xs group-hover:-translate-x-0.5 transition-transform duration-200"></i>
                <span>Back to Top</span>
              </button>
            }
            <div>
              <h1 class="text-xl font-semibold text-gray-900 mb-1">
                @if (isRootView()) {
                  Matrix View
                } @else {
                  {{ currentRootNode().username }}'s Network
                }
              </h1>
              <p class="text-gray-500 text-xs">Visualise your binary tree structure</p>
            </div>
          </div>
          <!-- Zoom Controls - Only visible on desktop -->
          <div class="hidden lg:flex gap-1.5">
            <button (click)="zoomIn()" class="w-8 h-8 rounded-lg bg-white border border-gray-200 flex items-center justify-center hover:bg-gray-50 hover:border-gray-300 transition-all text-gray-500 hover:text-gray-700 shadow-sm">
              <i class="pi pi-plus text-xs"></i>
            </button>
            <button (click)="zoomOut()" class="w-8 h-8 rounded-lg bg-white border border-gray-200 flex items-center justify-center hover:bg-gray-50 hover:border-gray-300 transition-all text-gray-500 hover:text-gray-700 shadow-sm">
              <i class="pi pi-minus text-xs"></i>
            </button>
          </div>
        </div>

        <!-- Desktop: Tree View - use viewport height so full tree can be seen at default zoom -->
        <div class="hidden lg:block flex-1 bg-white rounded-2xl border border-gray-100 relative overflow-hidden shadow-sm min-h-[500px] h-[calc(100vh-12rem)]">
          <!-- Draggable/Scrollable Area -->
          <div class="absolute inset-0 overflow-auto flex items-center justify-center p-8 cursor-grab active:cursor-grabbing">
            <div [style.transform]="'scale(' + zoomLevel() + ')'" class="transition-transform duration-200 origin-center flex-shrink-0">
              <p-organization-chart 
                [value]="matrixTree()" 
                (onNodeSelect)="onNodeSelect($event)">
                <ng-template let-node pTemplate="default">
                  @if (node.data) {
                    @if (node.data.status === 'empty') {
                      <!-- Empty Slot - Not clickable -->
                      <div 
                        class="flex flex-col items-center justify-center px-6 py-5 rounded-2xl border-2 border-dashed border-gray-200 bg-gray-50/50 w-32 cursor-not-allowed"
                        [pTooltip]="getTooltipText(node.data)"
                        tooltipPosition="top">
                        <div class="w-10 h-10 rounded-full bg-gray-100 flex items-center justify-center mb-2">
                          <i class="pi pi-plus text-gray-400 text-sm"></i>
                        </div>
                        <span class="text-[10px] font-semibold text-gray-400 uppercase tracking-wide">Open Slot</span>
                      </div>
                    } @else {
                      <!-- Active/Inactive Node -->
                      <div 
                        class="flex flex-col items-center px-5 py-4 w-32 relative"
                        [class.opacity-50]="node.data.status === 'inactive'"
                        [class.cursor-pointer]="!isCurrentRoot(node.data.id)"
                        [class.cursor-default]="isCurrentRoot(node.data.id)"
                        [pTooltip]="getTooltipText(node.data)"
                        tooltipPosition="top"
                        (click)="handleNodeClick(node.data)">
                        
                        <!-- Details control: info icon (stops propagation) -->
                        <button
                          type="button"
                          class="absolute top-1 right-1 w-6 h-6 rounded-full bg-gray-200/80 hover:bg-gray-300 flex items-center justify-center text-gray-600 hover:text-gray-800 z-10"
                          (click)="$event.stopPropagation(); openNodeDetails(node.data)"
                          [pTooltip]="'Details'"
                          tooltipPosition="top"
                          aria-label="View details">
                          <i class="pi pi-info text-[10px]"></i>
                        </button>
                        
                        <!-- Package Badge Circle -->
                        <div class="w-9 h-9 rounded-full flex items-center justify-center mb-2 text-sm font-bold"
                             [ngClass]="getPackageBgClass(node.data.package)">
                          {{ getPackageInitial(node.data.package) }}
                        </div>

                        <!-- Username -->
                        <span class="text-xs font-semibold text-gray-800 truncate max-w-full mb-1">{{ node.data.username }}</span>
                        
                        <!-- Level Badge -->
                        <span class="text-[10px] font-medium text-blue-500 uppercase tracking-wide">LVL {{ node.data.level }}</span>
                      </div>
                    }
                  }
                </ng-template>
              </p-organization-chart>
            </div>
          </div>
        </div>

        <!-- Mobile: List View Fallback -->
        <div class="lg:hidden bg-white rounded-2xl border border-gray-100 shadow-sm overflow-hidden">
          <div class="px-4 py-3 border-b border-gray-100 bg-slate-50 flex items-center justify-between">
            @if (!isRootView()) {
              <button 
                (click)="navigateToTop()"
                class="group flex items-center gap-2 px-3 py-1.5 rounded-lg bg-white border border-gray-200 hover:border-gray-300 hover:bg-gray-50 transition-all duration-200 text-gray-700 text-xs font-medium">
                <i class="pi pi-arrow-left text-xs group-hover:-translate-x-0.5 transition-transform duration-200"></i>
                <span>Back</span>
              </button>
            }
            <span class="text-xs font-semibold text-gray-500 uppercase tracking-wide ml-auto">Network Members</span>
          </div>
          
          <div class="divide-y divide-gray-100">
            @for (node of flattenedNodes(); track node.id) {
              <div 
                class="flex items-center gap-4 px-4 py-3 transition-colors"
                [class.cursor-pointer]="node.status !== 'empty' && !isRootNode(node.id)"
                [class.cursor-not-allowed]="node.status === 'empty' || isRootNode(node.id)"
                [class.opacity-50]="node.status === 'inactive'"
                [class.hover:bg-slate-50]="node.status !== 'empty' && !isRootNode(node.id)"
                (click)="onListNodeClick(node)">
                
                <!-- Level Indicator -->
                <div class="w-8 text-center">
                  <span class="text-[10px] font-bold text-blue-500 uppercase">L{{ node.level }}</span>
                </div>
                
                <!-- Package Badge -->
                <div class="w-8 h-8 rounded-full flex items-center justify-center text-xs font-bold shrink-0"
                     [ngClass]="{
                       'bg-amber-400 text-white': node.package === 'vip',
                       'bg-violet-500 text-white': node.package === 'premium',
                       'bg-slate-400 text-white': node.package === 'basic',
                       'bg-gray-100 text-gray-400': !node.package
                     }">
                  @if (node.status === 'empty') {
                    <i class="pi pi-plus text-[10px]"></i>
                  } @else {
                    {{ node.package === 'vip' ? 'G' : node.package === 'premium' ? 'P' : node.package === 'basic' ? 'S' : '?' }}
                  }
                </div>
                
                <!-- User Info -->
                <div class="flex-1 min-w-0">
                  <p class="text-sm font-semibold text-gray-900 truncate">{{ node.username }}</p>
                  <p class="text-[10px] text-gray-500">
                    @if (node.status !== 'empty') {
                      {{ getPackageLabel(node.package) }}
                    } @else {
                      Available Slot
                    }
                  </p>
                </div>
                
                <!-- Status Badge -->
                <span [class]="'px-2 py-1 rounded text-[9px] font-semibold uppercase tracking-wide shrink-0 ' + getStatusClass(node.status)">
                  {{ node.status }}
                </span>
                
                <!-- Details button (mobile): stops propagation so row click still drills down when tapping elsewhere -->
                @if (node.status !== 'empty') {
                  <button
                    type="button"
                    class="shrink-0 px-2 py-1 rounded-lg bg-gray-100 hover:bg-gray-200 text-gray-600 text-[10px] font-semibold"
                    (click)="$event.stopPropagation(); openDetailsForFlat(node)"
                    aria-label="View details">
                    Details
                  </button>
                }
                <!-- Arrow -->
                @if (node.status !== 'empty' && !isRootNode(node.id)) {
                  <i class="pi pi-chevron-right text-gray-300 text-xs"></i>
                }
              </div>
            }
          </div>
        </div>
      </div>
    </div>
  </main>

  <!-- Node details modal -->
  <p-dialog
    [visible]="nodeForModal() !== null"
    (visibleChange)="onDialogVisibleChange($event)"
    [modal]="true"
    [closable]="true"
    [draggable]="false"
    [resizable]="false"
    header="Member details"
    styleClass="w-full max-w-sm"
    [contentStyle]="{ padding: '1rem' }">
    @if (nodeForModal(); as node) {
      <div class="space-y-3 text-sm">
        <p><span class="font-semibold text-gray-500">Username</span><br/><span class="text-gray-900">{{ node.username }}</span></p>
        <p><span class="font-semibold text-gray-500">Package</span><br/><span class="text-gray-900">{{ getPackageLabel(node.package) }}</span></p>
        <p><span class="font-semibold text-gray-500">Level</span><br/><span class="text-gray-900">{{ node.level }}</span></p>
        <p><span class="font-semibold text-gray-500">Status</span><br/><span [class]="node.status === 'active' ? 'text-emerald-600' : 'text-gray-500'">{{ node.status === 'active' ? 'Active' : 'Inactive' }}</span></p>
      </div>
    }
  </p-dialog>
</div>
