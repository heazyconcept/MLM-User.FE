<div class="min-h-screen bg-mlm-background">
  <main class="py-8">
    <div class="px-4 sm:px-6 lg:px-8 mx-auto">

      @if (!isPaid()) {
        <!-- Access Restricted State -->
        <div class="max-w-3xl mx-auto">
          <div class="bg-white rounded-xl border border-gray-200 shadow-sm p-8">
            <div class="flex flex-col items-center text-center py-6 space-y-5">
              <div class="w-16 h-16 bg-gray-100 rounded-full flex items-center justify-center">
                <i class="pi pi-lock text-2xl text-gray-500" aria-hidden="true"></i>
              </div>
              <div class="space-y-1">
                <h3 class="text-lg font-semibold text-gray-900">Complete registration</h3>
                <p class="text-gray-500 text-sm max-w-md">
                  Pay your registration fee to access your wallet, view transactions, and make withdrawals.
                </p>
              </div>
              <button
                type="button"
                (click)="navigateToPayment()"
                class="px-5 py-2.5 bg-mlm-primary text-white text-sm font-medium rounded-lg hover:opacity-90 transition-colors">
                Pay Registration Fee
              </button>
            </div>
          </div>
        </div>
      } @else {
        @if (isLoading()) {
          <!-- Skeleton Loading State -->
          <div class="space-y-6 animate-pulse">
            <!-- Header Skeleton -->
            <div class="flex flex-col md:flex-row md:items-center justify-between gap-4">
              <div class="space-y-2">
                <p-skeleton width="180px" height="2rem"></p-skeleton>
                <p-skeleton width="280px" height="1rem"></p-skeleton>
              </div>
              <div class="flex gap-2">
                <p-skeleton width="100px" height="2.5rem" borderRadius="12px"></p-skeleton>
                <p-skeleton width="140px" height="2.5rem" borderRadius="12px"></p-skeleton>
              </div>
            </div>

            <!-- Main Grid Skeleton (matches wallet cards + right sidebar) -->
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
              <div class="lg:col-span-2 space-y-6">
                <p-skeleton height="280px" borderRadius="12px"></p-skeleton>
                <p-skeleton height="280px" borderRadius="12px"></p-skeleton>
              </div>
              <div class="space-y-4">
                <p-skeleton height="240px" borderRadius="16px"></p-skeleton>
                <p-skeleton height="200px" borderRadius="16px"></p-skeleton>
                <p-skeleton height="100px" borderRadius="16px"></p-skeleton>
              </div>
            </div>
          </div>
        } @else {
          <div class="space-y-6 animate-fade-in">
            <!-- Header -->
            <div class="flex flex-col md:flex-row md:items-center justify-between gap-4">
              <div>
                <h1 class="text-2xl font-bold text-gray-900">My Wallet</h1>
                <p class="text-gray-500 text-sm mt-1">Manage your balances and withdraw your earnings.</p>
              </div>
              <div class="flex flex-wrap gap-2">
                <button
                  (click)="navigateToFunding()"
                  class="inline-flex items-center gap-2 px-4 py-2.5 bg-white border border-gray-200 text-gray-700 text-sm font-medium rounded-xl hover:bg-gray-50 transition-colors">
                  Fund wallet
                </button>
                <button
                  (click)="navigateToTransactions()"
                  class="inline-flex items-center gap-2 px-4 py-2.5 bg-mlm-primary text-white text-sm font-medium rounded-xl hover:opacity-90 transition-colors">
                  View Transactions
                </button>
              </div>
            </div>

            <!-- Empty State -->
            @if (hasZeroBalance()) {
              <div class="bg-white rounded-xl border border-gray-200 shadow-sm p-8 max-w-3xl mx-auto">
                <div class="flex flex-col items-center text-center py-6 space-y-5">
                  <div class="w-16 h-16 bg-gray-100 rounded-full flex items-center justify-center">
                    <i class="pi pi-wallet text-2xl text-gray-500" aria-hidden="true"></i>
                  </div>
                  <div class="space-y-1">
                    <h3 class="text-lg font-semibold text-gray-900">No balance yet</h3>
                    <p class="text-gray-500 text-sm max-w-md">
                      Fund your wallet or start earning commissions by inviting friends.
                    </p>
                  </div>
                  <div class="flex flex-wrap justify-center gap-2">
                    <button
                      (click)="navigateToFunding()"
                      class="px-4 py-2.5 bg-mlm-primary text-white text-sm font-medium rounded-lg hover:opacity-90 transition-colors">
                      Fund Wallet
                    </button>
                    <button
                      routerLink="/network/referrals"
                      class="px-4 py-2.5 bg-white border border-gray-200 text-mlm-secondary text-sm font-medium rounded-lg hover:bg-gray-50 transition-colors">
                      Invite Friends
                    </button>
                    <button
                      (click)="navigateToMarketplace()"
                      class="px-4 py-2.5 bg-white border border-gray-200 text-mlm-secondary text-sm font-medium rounded-lg hover:bg-gray-50 transition-colors">
                      Browse Products
                    </button>
                  </div>
                </div>
              </div>
            } @else {
              <!-- Main Grid: Wallet Cards + Right Sidebar -->
              <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                
                <!-- Left Section: Wallet Type Cards -->
                <div class="lg:col-span-2 space-y-6">
                  @for (wallet of wallets(); track wallet.id) {
                    <section class="bg-white rounded-xl border border-gray-200 shadow-sm overflow-hidden">
                      <!-- Card header -->
                      <div class="px-6 py-4 border-b border-gray-100">
                        <div class="flex items-center justify-between">
                          <h3 class="text-base font-semibold text-gray-900">{{ wallet.currency }} Wallet</h3>
                          <div class="text-right">
                            <span class="text-sm font-medium text-gray-900">Total {{ formatCurrency(wallet.balance, wallet.currency) }}</span>
                            @if (!isBalanceHidden()) {
                              <p class="text-xs text-gray-500 mt-0.5">{{ formatSecondaryEquivalent(wallet.balance, wallet.currency) }}</p>
                            }
                          </div>
                        </div>
                      </div>

                      <div class="divide-y divide-gray-100">
                        <!-- Cash Wallet -->
                        <div class="px-6 py-4 flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4">
                          <div class="min-w-0">
                            <p class="text-sm font-medium text-gray-900">Cash Wallet</p>
                            <p class="text-xl font-semibold text-gray-900 mt-0.5">{{ formatCurrency(wallet.cashBalance, wallet.currency) }}</p>
                            <span class="text-xs text-gray-500 mt-1 inline-block"
                                  pTooltip="Can be withdrawn to your bank account"
                                  tooltipPosition="top">Withdrawable</span>
                          </div>
                          <div class="flex gap-2 shrink-0">
                            <button
                              (click)="openWithdrawDialog(wallet)"
                              [disabled]="wallet.cashBalance <= 0"
                              class="px-4 py-2 text-sm font-medium text-white bg-mlm-primary rounded-lg hover:opacity-90 transition-colors disabled:opacity-50 disabled:cursor-not-allowed">
                              Withdraw
                            </button>
                            <button
                              (click)="navigateToFunding()"
                              class="px-4 py-2 text-sm font-medium text-mlm-secondary bg-white border border-gray-200 rounded-lg hover:bg-gray-50 transition-colors">
                              Fund
                            </button>
                          </div>
                        </div>

                        <!-- Voucher Wallet -->
                        <div class="px-6 py-4 flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4">
                          <div class="min-w-0">
                            <p class="text-sm font-medium text-gray-900">Voucher Wallet</p>
                            <p class="text-xl font-semibold text-gray-900 mt-0.5">{{ formatCurrency(wallet.voucherBalance, wallet.currency) }}</p>
                            @if (!isBalanceHidden()) {
                              <p class="text-xs text-gray-500 mt-0.5">{{ formatSecondaryEquivalent(wallet.voucherBalance, wallet.currency) }}</p>
                            }
                            <span class="text-xs text-gray-500 mt-1 inline-block"
                                  pTooltip="Can only be used for product purchases"
                                  tooltipPosition="top">Non-withdrawable</span>
                          </div>
                          <button
                            (click)="navigateToMarketplace()"
                            class="px-4 py-2 text-sm font-medium text-white bg-mlm-primary rounded-lg hover:opacity-90 transition-colors shrink-0 w-fit">
                            Browse Products
                          </button>
                        </div>

                        <!-- Autoship Wallet -->
                        <div class="px-6 py-4">
                          <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4">
                            <div class="min-w-0">
                              <p class="text-sm font-medium text-gray-900">Autoship Wallet</p>
                              <p class="text-xl font-semibold text-gray-900 mt-0.5">{{ formatCurrency(wallet.autoshipBalance, wallet.currency) }}</p>
                              @if (!isBalanceHidden()) {
                                <p class="text-xs text-gray-500 mt-0.5">{{ formatSecondaryEquivalent(wallet.autoshipBalance, wallet.currency) }}</p>
                              }
                              <span class="text-xs text-gray-500 mt-1 inline-block"
                                    pTooltip="Auto product credits for recurring orders"
                                    tooltipPosition="top">Non-withdrawable · Recurring orders</span>
                            </div>
                          </div>
                        </div>
                      </div>
                    </section>
                  }
                </div>

                <!-- Right Sidebar: Total Balance -->
                <div class="space-y-4">
                  
                  <!-- Total Balance Card -->
                  <div class="bg-gradient-to-br from-mlm-primary to-brand-green-dark rounded-2xl p-6 text-white shadow-sm relative overflow-hidden">
                    <!-- Background Pattern -->
                    <div class="absolute inset-0 opacity-10">
                      <div class="absolute top-0 right-0 w-40 h-40 bg-white rounded-full -translate-y-1/2 translate-x-1/4"></div>
                      <div class="absolute bottom-0 left-0 w-32 h-32 bg-white rounded-full translate-y-1/2 -translate-x-1/4"></div>
                    </div>
                    
                    <div class="relative z-10">
                      <div class="flex items-center gap-2 mb-4">
                        <div class="w-10 h-10 rounded-xl bg-white/20 flex items-center justify-center">
                          <i class="pi pi-wallet text-xl"></i>
                        </div>
                        <span class="text-sm font-medium opacity-90">Total Balance</span>
                      </div>
                      
                      <div class="mb-6">
                        <div class="flex items-center gap-3">
                          <p class="text-3xl font-bold">
                            @if (isBalanceHidden()) {
                              {{ getHiddenBalance() }}
                            } @else {
                              {{ formatCurrency(totalBalance(), 'USD') }}
                            }
                          </p>
                          <!-- Eye Toggle Button -->
                          <button 
                            (click)="toggleBalanceVisibility()"
                            class="w-8 h-8 rounded-lg bg-white/10 hover:bg-white/20 flex items-center justify-center transition-colors">
                            <i [class]="'pi text-sm ' + (isBalanceHidden() ? 'pi-eye' : 'pi-eye-slash')"></i>
                          </button>
                        </div>
                        @if (!isBalanceHidden()) {
                          <p class="text-xs opacity-80 mt-1">{{ formatSecondaryEquivalent(totalBalance(), 'USD') }}</p>
                        }
                        <p class="text-xs opacity-70 mt-1">Across all wallets</p>
                      </div>

                      <div class="grid grid-cols-2 gap-3">
                        <button 
                          (click)="navigateToWithdrawals()"
                          class="py-2.5 px-4 bg-white/20 hover:bg-white/30 rounded-xl text-xs font-semibold transition-colors flex items-center justify-center gap-2">
                          <i class="pi pi-history text-xs"></i>
                          History
                        </button>
                        <button 
                          (click)="navigateToFunding()"
                          class="py-2.5 px-4 bg-white text-mlm-primary hover:bg-brand-green-light rounded-xl text-xs font-semibold transition-colors flex items-center justify-center gap-2">
                          <i class="pi pi-plus text-xs"></i>
                          Fund
                        </button>
                      </div>
                    </div>
                  </div>

                  <!-- Balance Breakdown -->
                  <div class="bg-white rounded-2xl border border-gray-100 p-5 shadow-sm">
                    <h3 class="text-sm font-semibold text-mlm-text mb-4">Balance Breakdown</h3>
                    
                    <div class="space-y-3">
                      <!-- Cash Balance -->
                      <div class="flex items-center justify-between p-3 bg-mlm-green-50 rounded-xl border border-mlm-green-100">
                        <div class="flex items-center gap-3">
                          <div class="w-8 h-8 rounded-lg bg-mlm-green-100 flex items-center justify-center">
                            <i class="pi pi-wallet text-mlm-green-600 text-sm"></i>
                          </div>
                          <div>
                            <p class="text-xs font-medium text-mlm-text">Cash Balance</p>
                            <p class="text-[10px] text-mlm-green-600">Withdrawable</p>
                          </div>
                        </div>
                        <span class="text-right">
                          <span class="text-sm font-bold text-mlm-text block">
                            @if (isBalanceHidden()) { •••••• } @else { {{ formatCurrency(totalCashBalance(), 'USD') }} }
                          </span>
                          @if (!isBalanceHidden()) {
                            <span class="text-[10px] text-mlm-secondary block mt-0.5">{{ formatSecondaryEquivalent(totalCashBalance(), 'USD') }}</span>
                          }
                        </span>
                      </div>

                      <!-- Voucher Balance -->
                      <div class="flex items-center justify-between p-3 bg-mlm-warm-50 rounded-xl border border-mlm-warm-200">
                        <div class="flex items-center gap-3">
                          <div class="w-8 h-8 rounded-lg bg-mlm-warm-100 flex items-center justify-center">
                            <i class="pi pi-ticket text-brand-gold text-sm"></i>
                          </div>
                          <div>
                            <p class="text-xs font-medium text-mlm-text">Voucher Balance</p>
                            <p class="text-[10px] text-mlm-warm-500">Products only</p>
                          </div>
                        </div>
                        <span class="text-right">
                          <span class="text-sm font-bold text-mlm-text block">
                            @if (isBalanceHidden()) { •••••• } @else { {{ formatCurrency(totalVoucherBalance(), 'USD') }} }
                          </span>
                          @if (!isBalanceHidden()) {
                            <span class="text-[10px] text-mlm-secondary block mt-0.5">{{ formatSecondaryEquivalent(totalVoucherBalance(), 'USD') }}</span>
                          }
                        </span>
                      </div>

                      <!-- Autoship Balance -->
                      <div class="flex items-center justify-between p-3 bg-mlm-teal-50 rounded-xl border border-mlm-teal-100">
                        <div class="flex items-center gap-3">
                          <div class="w-8 h-8 rounded-lg bg-mlm-teal-100 flex items-center justify-center">
                            <i class="pi pi-sync text-mlm-teal-600 text-sm"></i>
                          </div>
                          <div>
                            <p class="text-xs font-medium text-mlm-text">Autoship Balance</p>
                            <p class="text-[10px] text-mlm-teal-600">Recurring orders</p>
                          </div>
                        </div>
                        <span class="text-right">
                          <span class="text-sm font-bold text-mlm-text block">
                            @if (isBalanceHidden()) { •••••• } @else { {{ formatCurrency(totalAutoshipBalance(), 'USD') }} }
                          </span>
                          @if (!isBalanceHidden()) {
                            <span class="text-[10px] text-mlm-secondary block mt-0.5">{{ formatSecondaryEquivalent(totalAutoshipBalance(), 'USD') }}</span>
                          }
                        </span>
                      </div>
                    </div>
                  </div>

                  <!-- Currency Info -->
                  <div class="bg-white rounded-2xl border border-gray-100 p-5 shadow-sm">
                    <div class="flex items-start gap-3">
                      <div class="w-8 h-8 rounded-lg bg-gray-100 flex items-center justify-center shrink-0">
                        <i class="pi pi-globe text-mlm-secondary text-sm"></i>
                      </div>
                      <div>
                        <p class="text-xs font-semibold text-mlm-text mb-1">Currency Display</p>
                        <p class="text-[10px] text-mlm-secondary leading-relaxed">
                          Balances are displayed in your registration currency. Currency conversion is not supported.
                        </p>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            }

            <!-- Quick Info / Business Rules -->
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
              <div class="bg-white p-5 rounded-xl shadow-sm border border-gray-200 flex items-start gap-4">
                <div class="bg-gray-100 p-3 rounded-lg shrink-0">
                  <i class="pi pi-info-circle text-gray-500 text-sm" aria-hidden="true"></i>
                </div>
                <div class="min-w-0">
                  <h4 class="font-semibold text-gray-900 text-sm">Currency Locked</h4>
                  <p class="text-xs text-gray-500 mt-1">Earnings stay in their original currency. No internal conversion is supported.</p>
                </div>
              </div>
              <div class="bg-white p-5 rounded-xl shadow-sm border border-gray-200 flex items-start gap-4">
                <div class="bg-gray-100 p-3 rounded-lg shrink-0">
                  <i class="pi pi-clock text-gray-500 text-sm" aria-hidden="true"></i>
                </div>
                <div class="min-w-0">
                  <h4 class="font-semibold text-gray-900 text-sm">Processing Time</h4>
                  <p class="text-xs text-gray-500 mt-1">Withdrawals are processed within 24-48 business hours.</p>
                </div>
              </div>
              <div class="bg-white p-5 rounded-xl shadow-sm border border-gray-200 flex items-start gap-4">
                <div class="bg-gray-100 p-3 rounded-lg shrink-0">
                  <i class="pi pi-shield text-gray-500 text-sm" aria-hidden="true"></i>
                </div>
                <div class="min-w-0">
                  <h4 class="font-semibold text-gray-900 text-sm">Secure Transactions</h4>
                  <p class="text-xs text-gray-500 mt-1">All transactions are encrypted and audited for your security.</p>
                </div>
              </div>
            </div>
          </div>
        }
      }
    </div>
  </main>
</div>
