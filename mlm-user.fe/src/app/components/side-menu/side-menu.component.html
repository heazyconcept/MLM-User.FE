
<!-- Mobile Menu Overlay -->
@if (mobileMenuOpen()) {
  <div
    class="fixed inset-0 z-50 lg:hidden"
    (click)="closeMobileMenu()"
    role="button"
    tabindex="0"
    [attr.aria-label]="'Close menu'">
    <div class="fixed inset-0 bg-mlm-text/80 transition-opacity"></div>
  </div>
}

<!-- Mobile Sidebar -->
<div
  class="fixed inset-y-0 left-0 z-50 w-full max-w-xs transform transition-transform duration-300 ease-in-out lg:hidden"
  [class.translate-x-0]="mobileMenuOpen()"
  [class.-translate-x-full]="!mobileMenuOpen()"
  role="navigation"
  [attr.aria-label]="'Main navigation'"
  style="overflow: visible;">
  <div class="relative flex h-full flex-col gap-y-5 overflow-y-auto bg-white px-6 pb-2 ring-1 ring-brand-green-light" style="overflow-x: visible;">
    <div class="relative flex h-16 shrink-0 items-center justify-start">
      <img src="assets/images/logo.png" alt="logo" class="h-10 w-auto">
      <button
        type="button"
        (click)="closeMobileMenu()"
        class="absolute right-0 p-2.5 text-mlm-secondary hover:text-mlm-text"
        aria-label="Close sidebar">
        <i class="pi pi-times text-xl"></i>
      </button>
    </div>
    <nav class="flex flex-1 flex-col">
      <ul role="list" class="flex flex-1 flex-col gap-y-7">
        <li>
          <ul role="list" class="-mx-2 space-y-2 overflow-visible">
            @for (item of menuItems(); track item.label) {
              <li>
                <div class="relative">
                  <a
                    (click)="navigate(item.route, item)"
                    (mouseenter)="isItemDisabled(item) && updateTooltipPosition($event)"
                    [class]="isActiveRoute(item.route) ? 'bg-brand-green-light text-mlm-primary shadow-sm' : 'text-mlm-text hover:bg-gray-50'"
                    [class.opacity-50]="isItemDisabled(item)"
                    [class.cursor-not-allowed]="isItemDisabled(item)"
                    class="group flex items-center gap-x-3 rounded-full px-4 py-2 text-sm font-semibold transition-all duration-200"
                    [attr.aria-current]="isActiveRoute(item.route) ? 'page' : null">
                    <i [class]="item.icon + ' w-5 h-5 shrink-0'"></i>
                    <span class="flex-1 text-sm font-medium">{{ item.label }}</span>
                    @if (item.children && item.children.length > 0) {
                      <i class="pi pi-chevron-right text-[10px] transition-transform duration-200" [class.rotate-90]="openMenus().has(item.label)"></i>
                    } @else {
                      <i class="pi pi-chevron-right text-[10px] opacity-0 group-hover:opacity-50 transition-opacity"></i>
                    }
                  </a>
                  
                  <!-- Tooltip for disabled items -->
                  @if (isItemDisabled(item)) {
                    <span 
                      data-tooltip
                      class="fixed px-3 py-1.5 bg-mlm-text text-white text-xs font-medium rounded whitespace-nowrap opacity-0 invisible group-hover:opacity-100 group-hover:visible pointer-events-none transition-all duration-200 z-100 shadow-lg -translate-y-1/2"
                      style="left: calc(18rem + 0.5rem); top: var(--tooltip-top, 0);">
                      Complete registration
                      <span class="absolute right-full top-1/2 -translate-y-1/2 border-4 border-transparent border-r-mlm-text"></span>
                    </span>
                  }

                </div>

                <!-- Submenu -->
                @if (item.children && item.children.length > 0 && openMenus().has(item.label)) {
                  <ul class="mt-1 ml-9 space-y-1 border-l border-brand-green-light pl-4">
                    @for (child of item.children; track child.label) {
                      <li>
                        <a
                          (click)="navigate(child.route, child)"
                          [class]="isActiveRoute(child.route) ? 'text-mlm-primary font-semibold' : 'text-mlm-text hover:text-mlm-primary'"
                          class="block py-1.5 text-xs font-medium transition-colors cursor-pointer">
                          {{ child.label }}
                        </a>
                      </li>
                    }
                  </ul>
                }
              </li>
            }
          </ul>
        </li>
      </ul>
      <div class="mt-auto -mx-6 px-6 pb-4">
        <!-- Expandable Menu Items -->
        <div 
          class="overflow-hidden transition-all duration-300 ease-in-out"
          [style.max-height]="isUserMenuExpanded() ? '200px' : '0'"
          [style.opacity]="isUserMenuExpanded() ? '1' : '0'">
          <div class="space-y-1 pb-3 border-b border-gray-100 mb-3">
            <a
              routerLink="/profile"
              (click)="closeMobileMenu()"
              class="flex items-center gap-x-3 rounded-lg px-3 py-2 text-sm text-mlm-text hover:bg-gray-50 hover:text-mlm-primary transition-all cursor-pointer">
              <i class="pi pi-user w-4 h-4 shrink-0"></i>
              Profile
            </a>
            <a
              routerLink="/settings"
              (click)="closeMobileMenu()"
              class="flex items-center gap-x-3 rounded-lg px-3 py-2 text-sm text-mlm-text hover:bg-gray-50 hover:text-mlm-primary transition-all cursor-pointer">
              <i class="pi pi-cog w-4 h-4 shrink-0"></i>
              Settings
            </a>
            <button
              (click)="logout()"
              class="w-full flex items-center gap-x-3 rounded-lg px-3 py-2 text-sm text-mlm-text hover:bg-gray-50 hover:text-mlm-primary transition-all">
              <i class="pi pi-sign-out w-4 h-4 shrink-0"></i>
              Sign Out
            </button>
          </div>
        </div>

        <!-- User Card Toggle -->
        @if (currentUser(); as user) {
          <button
            (click)="toggleUserMenu()"
            class="w-full flex items-center gap-x-3 py-3 text-sm font-semibold text-mlm-text hover:bg-gray-50 rounded-xl px-2 transition-colors cursor-pointer">
            <div class="flex size-8 shrink-0 items-center justify-center rounded-full bg-brand-green-light border border-brand-green-light text-xs text-mlm-primary font-bold">
              {{ user.firstName.charAt(0) }}{{ user.lastName.charAt(0) }}
            </div>
            <div class="flex-1 min-w-0 text-left">
              <p class="truncate text-sm font-semibold">{{ user.firstName }} {{ user.lastName }}</p>
            </div>
            <i class="pi pi-chevron-up text-xs text-mlm-secondary transition-transform duration-300"
               [class.rotate-180]="!isUserMenuExpanded()"></i>
          </button>
        }
      </div>
    </nav>
  </div>
</div>

<!-- Desktop Sidebar -->
<div class="hidden bg-white lg:fixed lg:inset-y-0 lg:z-50 lg:flex lg:w-72 lg:flex-col shadow-sm border-r border-gray-100" style="overflow: visible;">
  <div class="flex grow flex-col gap-y-5 overflow-y-auto px-6" style="overflow-x: visible;">
    <div class="flex h-16 shrink-0 items-center justify-start">
      <img src="assets/images/logo.png" alt="logo" class="h-12 w-auto">
    </div>
    <nav class="flex flex-1 flex-col">
      <ul role="list" class="flex flex-1 flex-col gap-y-7">
        <li>
          <ul role="list" class="-mx-2 space-y-2 overflow-visible">
            @for (item of menuItems(); track item.label) {
              <li>
                <div class="relative">
                  <a
                    (click)="navigate(item.route, item)"
                    (mouseenter)="isItemDisabled(item) && updateTooltipPosition($event)"
                    [class]="isActiveRoute(item.route) ? 'bg-brand-green-light text-mlm-primary shadow-sm' : 'text-mlm-text hover:bg-gray-50'"
                    [class.opacity-50]="isItemDisabled(item)"
                    [class.cursor-not-allowed]="isItemDisabled(item)"
                    class="group flex items-center gap-x-3 rounded-full px-4 py-2.5 text-[15px] font-semibold cursor-pointer transition-all duration-200"
                    [attr.aria-current]="isActiveRoute(item.route) ? 'page' : null">
                    <i [class]="item.icon + ' w-5 h-5 shrink-0'"></i>
                    <span class="flex-1 font-medium">{{ item.label }}</span>
                    @if (item.children && item.children.length > 0) {
                      <i class="pi pi-chevron-right text-[10px] transition-transform duration-200" [class.rotate-90]="openMenus().has(item.label)"></i>
                    } @else {
                      <i class="pi pi-chevron-right text-[10px] opacity-0 group-hover:opacity-50 transition-opacity"></i>
                    }
                  </a>
                  
                  @if (isItemDisabled(item)) {
                    <span 
                      data-tooltip
                      class="fixed px-3 py-1.5 bg-mlm-text text-white text-xs font-medium rounded whitespace-nowrap opacity-0 invisible group-hover:opacity-100 group-hover:visible pointer-events-none transition-all duration-200 z-100 shadow-lg -translate-y-1/2"
                      style="left: calc(18rem + 0.5rem); top: var(--tooltip-top, 0);">
                      Complete registration
                      <span class="absolute right-full top-1/2 -translate-y-1/2 border-4 border-transparent border-r-mlm-text"></span>
                    </span>
                  }

                </div>

                <!-- Submenu -->
                @if (item.children && item.children.length > 0 && openMenus().has(item.label)) {
                  <ul class="mt-1 ml-9 space-y-1 border-l border-brand-green-light pl-4">
                    @for (child of item.children; track child.label) {
                      <li>
                        <a
                          (click)="navigate(child.route, child)"
                          [class]="isActiveRoute(child.route) ? 'text-mlm-primary font-bold' : 'text-mlm-text hover:text-mlm-primary'"
                          class="block py-1.5 text-xs font-medium transition-colors cursor-pointer">
                          {{ child.label }}
                        </a>
                      </li>
                    }
                  </ul>
                }
              </li>
            }
          </ul>
        </li>
      </ul>
      <div class="mt-auto -mx-6 px-6 pb-6">
        <!-- Expandable Menu Items -->
        <div 
          class="overflow-hidden transition-all duration-300 ease-in-out"
          [style.max-height]="isUserMenuExpanded() ? '200px' : '0'"
          [style.opacity]="isUserMenuExpanded() ? '1' : '0'">
          <div class="space-y-1 pb-3 border-b border-gray-100 mb-3">
            <a
              routerLink="/profile"
              class="flex items-center gap-x-3 rounded-lg px-3 py-2 text-sm text-mlm-text hover:bg-gray-50 hover:text-mlm-primary transition-all cursor-pointer">
              <i class="pi pi-user w-4 h-4 shrink-0"></i>
              Profile
            </a>
            <a
              routerLink="/settings"
              class="flex items-center gap-x-3 rounded-lg px-3 py-2 text-sm text-mlm-text hover:bg-gray-50 hover:text-mlm-primary transition-all cursor-pointer">
              <i class="pi pi-cog w-4 h-4 shrink-0"></i>
              Settings
            </a>
            <button
              (click)="logout()"
              class="w-full flex items-center gap-x-3 rounded-lg px-3 py-2 text-sm text-mlm-text hover:bg-gray-50 hover:text-mlm-primary transition-all">
              <i class="pi pi-sign-out w-4 h-4 shrink-0"></i>
              Sign Out
            </button>
          </div>
        </div>

        <!-- User Card Toggle -->
        @if (currentUser(); as user) {
          <button
            (click)="toggleUserMenu()"
            class="w-full flex items-center gap-x-3 py-3 text-sm font-semibold text-mlm-text hover:bg-gray-50 rounded-xl px-2 transition-colors cursor-pointer">
            <div class="flex size-9 shrink-0 items-center justify-center rounded-full bg-brand-green-light border border-brand-green-light text-xs text-mlm-primary font-bold shadow-sm">
              {{ user.firstName.charAt(0) }}{{ user.lastName.charAt(0) }}
            </div>
            <div class="flex-1 min-w-0 text-left">
              <p class="truncate text-sm font-semibold">{{ user.firstName }} {{ user.lastName }}</p>
            </div>
            <i class="pi pi-chevron-up text-xs text-mlm-secondary transition-transform duration-300"
               [class.rotate-180]="!isUserMenuExpanded()"></i>
          </button>
        }
      </div>
    </nav>
  </div>
</div>

