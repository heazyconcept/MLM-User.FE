<div class="flex flex-col items-center">
  <!-- Node Card -->
  @if (node.status === 'empty') {
    <!-- Empty Slot - Not clickable -->
    <div 
      class="flex flex-col items-center justify-center px-6 py-5 rounded-2xl border-2 border-dashed border-gray-200 bg-gray-50/50 w-32 cursor-not-allowed"
      [pTooltip]="getTooltipText()"
      tooltipPosition="top">
      <div class="w-10 h-10 rounded-full bg-gray-100 flex items-center justify-center mb-2">
        <i class="pi pi-plus text-gray-400 text-sm"></i>
      </div>
      <span class="text-[10px] font-semibold text-gray-400 uppercase tracking-wide">Open Slot</span>
    </div>
  } @else {
    <!-- Active/Inactive Node -->
    <div 
      class="flex flex-col items-center px-5 py-4 rounded-2xl bg-white border border-gray-100 shadow-sm w-32"
      [class.opacity-50]="node.status === 'inactive'"
      [class.cursor-pointer]="!isRoot"
      [class.cursor-default]="isRoot"
      [pTooltip]="getTooltipText()"
      tooltipPosition="top"
      (click)="onNodeClick()">
      
      <!-- Package Badge Circle -->
      <div class="w-9 h-9 rounded-full flex items-center justify-center mb-2 text-sm font-bold"
           [ngClass]="getPackageBgClass(node.package)">
        {{ getPackageInitial(node.package) }}
      </div>

      <!-- Username -->
      <span class="text-xs font-semibold text-gray-800 truncate max-w-full mb-1">{{ node.username }}</span>
      
      <!-- Level Badge -->
      <span class="text-[10px] font-medium text-blue-500 uppercase tracking-wide">LVL {{ node.level }}</span>
    </div>
  }

  <!-- Connector Lines to Children -->
  @if (node.children?.length) {
    <div class="flex flex-col items-center">
      <!-- Vertical Line Down from Parent -->
      <div class="w-px h-8" [ngClass]="node.status === 'empty' ? 'border-l border-dashed border-gray-300' : 'bg-blue-200'"></div>
      
      <!-- Children Container -->
      <div class="flex items-start">
        @for (child of node.children; track child.id; let first = $first; let last = $last) {
          <div class="flex flex-col items-center relative">
            <!-- Horizontal connector: left half (except for first child) -->
            @if (!first) {
              <div class="absolute top-0 right-1/2 left-0 h-px" 
                   [ngClass]="child.status === 'empty' || getPreviousChild(child)?.status === 'empty' ? 'border-t border-dashed border-gray-300' : 'bg-blue-200'"></div>
            }
            <!-- Horizontal connector: right half (except for last child) -->
            @if (!last) {
              <div class="absolute top-0 left-1/2 right-0 h-px"
                   [ngClass]="child.status === 'empty' ? 'border-t border-dashed border-gray-300' : 'bg-blue-200'"></div>
            }
            
            <!-- Vertical Line to Child -->
            <div class="w-px h-8 relative z-10" [ngClass]="child.status === 'empty' ? 'border-l border-dashed border-gray-300' : 'bg-blue-200'"></div>
            
            <!-- Child Node -->
            <div class="px-4">
              <app-tree-node 
                [node]="child" 
                [isRoot]="false"
                (nodeClick)="nodeClick.emit($event)"></app-tree-node>
            </div>
          </div>
        }
      </div>
    </div>
  }
</div>
